<script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
<script src = "/socket.io/socket.io.js"></script>
<div id="video-grid" ></div>

<p>fsdfjk</p>
<script>
var socket = io.connect()
const videoGrid = document.getElementById('video-grid')
const myVideo = document.createElement('video')
const peer = new Peer()

peer.on('open', id => {
  socket.emit('peerjoined', id)
})


myVideo.muted = true
myVideo.loop = ""
myVideo.playsInline= ""
myVideo.preload = "auto"

navigator.mediaDevices.getUserMedia({
    video:true,
    audio:true
}).then(stream=>{
    //all this does is just make the element video source object equal to stream. And when loadedmeta data the video plays
    addVideoStream(myVideo, stream)

    /////////receive calls

    peer.on('call', call=>{
        call.answer(stream)
        const video = document.createElement('video')
        call.on('stream',uservideostream=>{
            addVideoStream(video, uservideostream)
        })
    })

    ///////receive calls

    ////////////make calls
    socket.on('user-connected',userid =>{
        const call = peer.call(userid,stream)
        const video = document.createElement('video')
        call.on('stream', userstream=>{
            addVideoStream(video,userstream)
        })
        call.on('close',()=>{
            video.remove()
        })
    })

    ////////////make calls
})



function addVideoStream(video, stream){
    video.srcObject = stream
    video.addEventListener('loadedmetadata', ()=>{
        video.play()
    })
    videoGrid.append(video)
}




</script>

<style>
    #video-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, 300px);
      grid-auto-rows: 300px;
    }

    video {
        background-color: black;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
</style>